<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SDG Master - Final Version</title>
    <style>
        :root {
            --bg-dark: #2D2D2D;
            --card-bg: #404040;
            --accent: #FFD700;
            --text-white: #ffffff;
            --correct-green: #4C9F38;
            --wrong-red: #E5243B;
            --coin-gold: #FFD700;
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-white);
            margin: 0;
            display: flex;
            justify-content: center;
            touch-action: manipulation;
            user-select: none;
            overflow-x: hidden;
        }

        #app-container {
            width: 100%;
            max-width: 450px;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
            position: relative;
        }

        .screen { display: none; flex-direction: column; }
        .active { display: flex; }

        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; font-size: 14px; }
        .back-btn { background: none; border: none; color: white; font-size: 24px; cursor: pointer; padding: 0; margin-right: 10px;}

        .currency-display { color: var(--coin-gold); font-weight: bold; display: flex; align-items: center; gap: 5px; font-size: 16px; }

        /* Men√º */
        .menu-btn {
            background-color: var(--card-bg);
            margin: 10px 0; padding: 18px;
            border-radius: 8px; cursor: pointer;
            display: flex; justify-content: space-between; align-items: center;
            transition: transform 0.1s;
        }
        .menu-btn:active { transform: scale(0.98); }
        .achievement-star { font-size: 24px; color: #555; transition: color 0.3s; }
        .achievement-star.unlocked { color: var(--accent); text-shadow: 0 0 5px rgba(255, 215, 0, 0.5); }

        /* Quiz UI */
        .sdg-display-box {
            width: 100%; height: 180px;
            display: flex; justify-content: center; align-items: center;
            border-radius: 12px; margin-bottom: 30px;
            font-size: 80px; font-weight: bold;
            transition: all 0.3s;
        }
        .sdg-display-box img { max-height: 140px; border-radius: 8px; }
        
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .option-btn {
            background-color: var(--card-bg); border: none; color: white;
            padding: 10px; border-radius: 6px; cursor: pointer; min-height: 90px;
            font-size: 13px; display: flex; align-items: center; justify-content: center;
            text-align: center; line-height: 1.2; transition: all 0.2s;
        }
        .option-btn:disabled { cursor: default; }

        /* Game Over Screen */
        #game-over-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 100;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            padding: 20px; box-sizing: border-box; text-align: center;
        }
        #game-over-screen.active { display: flex; }
        
        .go-title { font-size: 32px; color: var(--wrong-red); margin-bottom: 20px; font-weight: bold; }
        .go-stats { margin-bottom: 30px; width: 100%; background: #333; padding: 15px; border-radius: 8px; }
        .stat-row { display: flex; justify-content: space-between; margin: 5px 0; font-size: 18px; }

        .go-btn { width: 100%; padding: 15px; border-radius: 8px; border: none; font-size: 16px; font-weight: bold; margin-bottom: 10px; cursor: pointer; }
        .btn-continue { background: var(--accent); color: black; }
        .btn-restart { background: var(--card-bg); color: white; border: 1px solid #666; }
        .btn-menu { background: transparent; color: #aaa; }

        /* Drag & Drop */
        .drop-zone-container { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .drop-zone { 
            background: var(--card-bg); min-height: 130px; border: 2px dashed #666; 
            border-radius: 8px; display: flex; flex-direction: column; align-items: center; 
            justify-content: center; text-align: center; padding: 10px; font-size: 12px; position: relative;
            transition: background 0.2s;
        }
        .drop-zone.filled { border-style: solid; border-color: transparent; }
        
        /* Shake Animation f√ºr Fehler */
        @keyframes shake {
            0% { transform: translateX(0); } 25% { transform: translateX(-5px); } 50% { transform: translateX(5px); } 75% { transform: translateX(-5px); } 100% { transform: translateX(0); }
        }
        .shake-it { animation: shake 0.4s; border-color: var(--wrong-red) !important; }

        .drag-items { display: flex; justify-content: space-around; padding: 15px; background: #333; border-radius: 8px; min-height: 70px; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        
        /* Drag Box Style */
        .drag-box { 
            width: 55px; height: 55px; display: flex; justify-content: center; align-items: center; 
            font-weight: bold; font-size: 22px; color: white; border-radius: 8px; cursor: grab; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.3); flex-shrink: 0; z-index: 10;
        }
        /* Wenn Drag Box im Drop-Zone ist, muss sie wieder greifbar sein */
        .drop-zone .drag-box { pointer-events: auto; cursor: grab; }

        .action-btn { background-color: var(--accent); color: black; border: none; padding: 15px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 16px; margin-top: 10px; width: 100%; }

        .correct { background-color: var(--correct-green) !important; color: white !important; }
        .wrong { background-color: var(--wrong-red) !important; color: white !important; }
        
        /* Flashcards */
        .flashcard { width: 100%; max-width: 300px; height: 400px; margin: 20px auto; background: white; color: black; border-radius: 15px; display: flex; justify-content: center; align-items: center; text-align: center; cursor: pointer; padding: 10px; box-shadow: 0 10px 20px rgba(0,0,0,0.3); }
        .flashcard img { border-radius: 10px; width: 280px; height: auto; }

        /* Liste */
        .list-row { display: flex; background: var(--card-bg); margin-bottom: 6px; align-items: center; border-radius: 4px; overflow: hidden; }
        .row-nr { width: 45px; height: 60px; display: flex; justify-content: center; align-items: center; font-weight: bold; flex-shrink: 0; }
        .row-img { width: 50px; height: 50px; margin: 0 10px; border-radius: 3px; flex-shrink: 0; object-fit: contain; }
        .row-text { font-size: 13px; padding-right: 10px; flex-grow: 1; }
    </style>
</head>
<body>

<div id="app-container">
    <div id="menu-screen" class="screen active">
        <h1 style="text-align:center; color:var(--accent);">SDG MASTER</h1>
        <div style="text-align:center; margin-bottom:20px;">
            <span class="currency-display" style="justify-content:center; font-size:20px;">
                ü™ô <span id="menu-coins">0</span>
            </span>
            <div style="font-size:12px; color:#888; margin-top:5px;">Sammle Sterne bei 80+ Punkten!</div>
        </div>
        
        <div class="menu-btn" onclick="startQuiz(4)">
            <span>Quiz (Normal)</span>
            <span id="star-quiz-easy" class="achievement-star">‚òÜ</span>
        </div>
        
        <div class="menu-btn" onclick="startQuiz(6)">
            <span>Quiz (Schwer & T√ºckisch)</span>
            <span id="star-quiz-hard" class="achievement-star">‚òÜ</span>
        </div>
        
        <div class="menu-btn" onclick="startDragDrop()">
            <span>Ziehen & Ablegen (Game)</span>
            <span id="star-drag" class="achievement-star">‚òÜ</span>
        </div>
        
        <div style="border-top:1px solid #555; margin:10px 0;"></div>

        <div class="menu-btn" onclick="startFlashcards(false)">Karteikarten (1-17)</div>
        <div class="menu-btn" onclick="startFlashcards(true)">Karteikarten (Zufall)</div>
        <div class="menu-btn" onclick="showTable()">Tabelle lernen</div>
    </div>

    <div id="quiz-screen" class="screen">
        <div class="top-bar">
            <button class="back-btn" onclick="showMenu()">‚Üê</button>
            <span id="lives-label-quiz" style="font-size:20px; letter-spacing:2px;">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span>
            <span class="currency-display">ü™ô <span id="ingame-coins-quiz">0</span></span>
            <span id="score-label" style="font-weight:bold;">0</span>
        </div>
        <div id="quiz-display" class="sdg-display-box"></div>
        <div id="quiz-options" class="options-grid"></div>
    </div>

    <div id="drag-screen" class="screen">
        <div class="top-bar">
            <button class="back-btn" onclick="showMenu()">‚Üê</button>
            <span id="lives-label-drag" style="font-size:20px; letter-spacing:2px;">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span>
            <span class="currency-display">ü™ô <span id="ingame-coins-drag">0</span></span>
            <span id="score-label-drag" style="font-weight:bold;">0</span>
        </div>
        <div id="drop-zones" class="drop-zone-container"></div>
        <div id="drag-pool" class="drag-items"></div>
        
        <button id="check-drag-btn" class="action-btn" onclick="checkDragAssignments()">Pr√ºfen</button>
        <button id="next-drag-btn" class="action-btn" style="display:none;" onclick="loadDrag()">N√§chste Runde</button>
    </div>

    <div id="game-over-screen">
        <div class="go-title">GAME OVER</div>
        
        <div class="go-stats">
            <div class="stat-row"><span>Dein Ergebnis:</span> <span id="go-score" style="color:white">0</span></div>
            <div class="stat-row"><span>Highscore:</span> <span id="go-best" style="color:var(--accent)">0</span></div>
        </div>

        <button class="go-btn btn-continue" onclick="buyContinue()" id="btn-continue">Weiterspielen (-10 ü™ô)</button>
        <button class="go-btn btn-restart" onclick="restartGame()">Neuer Versuch</button>
        <button class="go-btn btn-menu" onclick="showMenu()">Zum Hauptmen√º</button>
    </div>

    <div id="flashcard-screen" class="screen">
        <div class="top-bar"><button class="back-btn" onclick="showMenu()">‚Üê</button><span id="card-progress"></span></div>
        <div id="main-card" class="flashcard" onclick="flipCard()"></div>
        <div style="display:flex; justify-content: space-around; margin-top: 20px;">
            <button class="option-btn" onclick="prevCard()" style="min-height: auto; width: 45%;">‚Üê</button>
            <button class="option-btn" onclick="nextCard()" style="min-height: auto; width: 45%;">‚Üí</button>
        </div>
    </div>

    <div id="table-screen" class="screen">
        <div class="top-bar"><button class="back-btn" onclick="showMenu()">‚Üê</button></div>
        <div id="table-content"></div>
    </div>
</div>

<script>
/* DATEN */
const SDGS = [
    {nr: 1, farbe: "#E5243B", titel: "Keine Armut"},
    {nr: 2, farbe: "#DDA63A", titel: "Kein Hunger"},
    {nr: 3, farbe: "#4C9F38", titel: "Gesundheit und Wohlergehen"},
    {nr: 4, farbe: "#C5192D", titel: "Hochwertige Bildung"},
    {nr: 5, farbe: "#FF3A21", titel: "Geschlechtergleichstellung"},
    {nr: 6, farbe: "#26BDE2", titel: "Sauberes Wasser und Sanit√§reinrichtungen"},
    {nr: 7, farbe: "#FCC30B", titel: "Bezahlbare und saubere Energie"},
    {nr: 8, farbe: "#A21942", titel: "Menschenw√ºrdige Arbeit und Wirtschaftswachstum"},
    {nr: 9, farbe: "#FD6925", titel: "Industrie, Innovation und Infrastruktur"},
    {nr: 10, farbe: "#DD1367", titel: "Weniger Ungleichheiten"},
    {nr: 11, farbe: "#FD9D24", titel: "Nachhaltige St√§dte und Gemeinden"},
    {nr: 12, farbe: "#BF8B2E", titel: "Nachhaltige/r Konsum und Produktion"},
    {nr: 13, farbe: "#3F7E44", titel: "Ma√ünahmen zum Klimaschutz"},
    {nr: 14, farbe: "#0A97D9", titel: "Leben unter Wasser"},
    {nr: 15, farbe: "#56C02B", titel: "Leben an Land"},
    {nr: 16, farbe: "#00689D", titel: "Frieden, Gerechtigkeit und starke Institutionen"},
    {nr: 17, farbe: "#19486A", titel: "Partnerschaften zur Erreichung der Ziele"}
];

/* STATE MANAGEMENT */
let playerStats = {
    coins: 0,
    scores: { quiz_easy: 0, quiz_hard: 0, drag: 0 }
};

if(localStorage.getItem("sdgAppData")) {
    let data = JSON.parse(localStorage.getItem("sdgAppData"));
    if(!data.scores) data.scores = { quiz_easy: data.highScore || 0, quiz_hard: 0, drag: 0 };
    playerStats = data;
}

function saveStats() {
    localStorage.setItem("sdgAppData", JSON.stringify(playerStats));
    updateUIStats();
}

function updateUIStats() {
    document.getElementById("menu-coins").innerText = playerStats.coins;
    document.getElementById("ingame-coins-quiz").innerText = playerStats.coins;
    document.getElementById("ingame-coins-drag").innerText = playerStats.coins;
    
    updateStar("star-quiz-easy", playerStats.scores.quiz_easy);
    updateStar("star-quiz-hard", playerStats.scores.quiz_hard);
    updateStar("star-drag", playerStats.scores.drag);
}

function updateStar(id, score) {
    const el = document.getElementById(id);
    if(score >= 80) { el.innerText = "‚òÖ"; el.classList.add("unlocked"); } 
    else { el.innerText = "‚òÜ"; el.classList.remove("unlocked"); }
}

updateUIStats();

/* DECK SYSTEM F√úR ZUF√ÑLLIGKEIT (Keine Dopplungen) */
let masterDeck = [];

function resetDeck() {
    masterDeck = [...SDGS].sort(() => Math.random() - 0.5);
}

function drawCard() {
    if(masterDeck.length === 0) resetDeck();
    return masterDeck.pop();
}

let score=0, lives=3, currentSdg=null, quizModeN=4, currentModeKey="quiz_easy"; 
let continueCost = 10;

function getImgUrl(nr) {
    const padded = nr.toString().padStart(2, "0");
    return `https://commons.wikimedia.org/wiki/Special:Redirect/file/SDG-icon-DE-${padded}.svg`;
}

function showMenu(){
    document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
    document.getElementById("game-over-screen").classList.remove("active");
    document.getElementById("menu-screen").classList.add("active");
    updateUIStats();
}

function updateLivesDisplay() {
    let hearts = "";
    for(let i=0; i<lives; i++) hearts += "‚ù§Ô∏è";
    for(let i=lives; i<3; i++) hearts += "üñ§";
    document.getElementById("lives-label-quiz").innerText = hearts;
    document.getElementById("lives-label-drag").innerText = hearts;
}

/* --- QUIZ --- */
function startQuiz(n){
    quizModeN = n;
    currentModeKey = (n > 4) ? "quiz_hard" : "quiz_easy";
    score = 0; lives = 3;
    resetDeck(); // Neues Deck beim Start
    document.getElementById("score-label").innerText = score;
    updateLivesDisplay();
    
    document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
    document.getElementById("game-over-screen").classList.remove("active");
    document.getElementById("quiz-screen").classList.add("active");
    nextQuizQuestion();
}

function nextQuizQuestion(){
    currentSdg = drawCard(); // Ziehe aus Deck statt Random
    const display = document.getElementById("quiz-display");
    const grid = document.getElementById("quiz-options");
    let mode = 0; if (quizModeN > 4) mode = Math.floor(Math.random() * 3) + 1; 

    display.style.background = "var(--card-bg)"; display.style.color = "white";
    display.style.fontSize = "80px"; display.innerHTML = ""; display.style.padding = "0";

    if (mode === 0) { display.style.background = currentSdg.farbe; display.innerHTML = `<span>${currentSdg.nr}</span>`; } 
    else if (mode === 1) { display.style.background = currentSdg.farbe; display.innerHTML = `<span>?</span>`; } 
    else if (mode === 2) { display.style.background = "#555"; display.innerHTML = `<span>${currentSdg.nr}</span>`; } 
    else if (mode === 3) { display.style.background = "#222"; display.style.fontSize = "24px"; display.style.padding = "20px"; display.style.textAlign = "center"; display.innerText = currentSdg.titel; }

    let opts = [currentSdg];
    while(opts.length < quizModeN){
        let r = SDGS[Math.floor(Math.random()*17)];
        if(!opts.find(o => o.nr === r.nr)) opts.push(r);
    }
    
    grid.innerHTML = "";
    opts.sort(()=>Math.random()-0.5).forEach(o=>{
        let b = document.createElement("button"); 
        b.className="option-btn"; b.dataset.nr = o.nr;
        if (mode === 3) { b.innerText = o.nr; b.style.backgroundColor = o.farbe; b.style.fontSize = "40px"; b.style.fontWeight = "bold"; } 
        else { b.innerText = o.titel; b.style.backgroundColor = "var(--card-bg)"; b.style.fontSize = "13px"; }

        b.onclick = () => {
            const isCorrect = o.nr === currentSdg.nr;
            const allButtons = grid.querySelectorAll("button");
            if (isCorrect) {
                allButtons.forEach(btn => btn.disabled = true);
                if (mode === 3) { b.style.border = "4px solid white"; b.style.opacity = "1"; } else { b.classList.add("correct"); }
                score++; playerStats.coins += 1; saveStats();
                document.getElementById("score-label").innerText = score;
                setTimeout(nextQuizQuestion, 1500);
            } else {
                lives--; updateLivesDisplay(); b.disabled = true;
                if (mode === 3) { b.style.opacity = "0.2"; b.style.border = "4px solid black"; } else { b.classList.add("wrong"); }
                if (lives <= 0) {
                    const correctBtn = Array.from(allButtons).find(btn => parseInt(btn.dataset.nr) === currentSdg.nr);
                    if (correctBtn) { if (mode === 3) correctBtn.style.border = "4px solid white"; else correctBtn.classList.add("correct"); }
                    allButtons.forEach(btn => btn.disabled = true);
                    finishGame();
                }
            }
        };
        grid.appendChild(b);
    });
}

/* --- DRAG & DROP GAME MODE (Mit Drag-Away & No-Popup) --- */
let currentDragData = [];

function startDragDrop(){
    currentModeKey = "drag";
    score = 0; lives = 3;
    resetDeck(); 
    document.getElementById("score-label-drag").innerText = score;
    updateLivesDisplay();

    document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
    document.getElementById("game-over-screen").classList.remove("active");
    document.getElementById("drag-screen").classList.add("active");
    
    // Pool auch als Dropzone definieren (zum Zur√ºcklegen)
    const pool = document.getElementById("drag-pool");
    pool.ondragover = e => e.preventDefault();
    pool.ondrop = e => handleDropOnPool(e);

    loadDrag();
}

function loadDrag(){
    // Ziehe 4 einzigartige aus dem Deck
    currentDragData = [];
    for(let i=0; i<4; i++) currentDragData.push(drawCard());
    
    const zones = document.getElementById("drop-zones");
    const pool = document.getElementById("drag-pool");
    zones.innerHTML = ""; pool.innerHTML = "";
    
    document.getElementById("check-drag-btn").style.display = "block";
    document.getElementById("check-drag-btn").disabled = false;
    document.getElementById("next-drag-btn").style.display = "none";

    // Drop Zones erstellen
    currentDragData.forEach((s, index) => {
        let z = document.createElement("div");
        z.className = "drop-zone";
        z.id = "zone-" + index;
        z.dataset.correctNr = s.nr;
        z.dataset.occupiedBy = "";
        z.innerText = s.titel;
        
        z.ondragover = e => e.preventDefault();
        z.ondrop = e => handleDrop(z, e.dataTransfer.getData("nr"), e.dataTransfer.getData("color"));
        zones.appendChild(z);
    });

    // Draggables erstellen
    [...currentDragData].sort(()=>Math.random()-0.5).forEach(s => {
        createDragItem(s.nr, s.farbe, "pool");
    });
}

function createDragItem(nr, color, origin) {
    let container = origin === "pool" ? document.getElementById("drag-pool") : document.getElementById(origin);
    
    // Check if item already exists to avoid dupes
    if(document.getElementById("d"+nr)) return;

    let box = document.createElement("div");
    box.id = "d" + nr;
    box.className = "drag-box";
    box.style.backgroundColor = color;
    box.innerText = nr;
    box.draggable = true;
    
    // Drag Start Logik
    box.ondragstart = e => {
        e.dataTransfer.setData("nr", nr);
        e.dataTransfer.setData("color", color);
        // Wir merken uns, woher das Item kommt (pool oder zone-id)
        let parentZone = box.closest(".drop-zone");
        e.dataTransfer.setData("sourceId", parentZone ? parentZone.id : "pool");
    };

    // Touch Support (Mobil)
    box.addEventListener('touchstart', function(e) {
        let touch = e.touches[0]; box.dataset.startX = touch.clientX; box.dataset.startY = touch.clientY;
        
        // Merken woher wir kommen
        let parentZone = box.closest(".drop-zone");
        box.dataset.sourceId = parentZone ? parentZone.id : "pool";

        box.style.position = 'fixed'; box.style.zIndex = '1000'; updatePosition(box, touch);
    }, {passive: false});

    box.addEventListener('touchmove', function(e) { e.preventDefault(); updatePosition(box, e.touches[0]); }, {passive: false});
    
    box.addEventListener('touchend', function(e) {
        box.style.display = 'none'; 
        let touch = e.changedTouches[0]; 
        let target = document.elementFromPoint(touch.clientX, touch.clientY);
        box.style.display = 'flex'; box.style.position = 'static'; 
        
        // Ziel finden
        let zone = target ? target.closest('.drop-zone') : null;
        let pool = target ? target.closest('#drag-pool') : null;

        if (zone) handleDrop(zone, nr, color);
        else if (pool) handleDropOnPool({ preventDefault: ()=>{}, dataTransfer: { getData: (k)=> (k==="nr"?nr:(k==="color"?color:box.dataset.sourceId)) } }, true);
        else {
            // Nirgendwo gelandet -> Reset Position
            box.style.position = 'static';
        }
    });

    if(container) container.appendChild(box);
}

function updatePosition(el, touch) { el.style.left = (touch.clientX - 25) + 'px'; el.style.top = (touch.clientY - 25) + 'px'; }

// Logik wenn etwas in den Pool zur√ºckgezogen wird
function handleDropOnPool(e, isTouch=false) {
    e.preventDefault();
    let nr = isTouch ? e.dataTransfer.getData("nr") : e.dataTransfer.getData("nr");
    let color = isTouch ? e.dataTransfer.getData("color") : e.dataTransfer.getData("color");
    let sourceId = isTouch ? e.dataTransfer.getData("sourceId") : e.dataTransfer.getData("sourceId"); // "pool" oder "zone-X"

    if(sourceId !== "pool") {
        // Item kam aus einer Zone -> Zone leeren
        let sourceZone = document.getElementById(sourceId);
        if(sourceZone) {
            sourceZone.classList.remove("filled");
            sourceZone.dataset.occupiedBy = "";
            sourceZone.innerText = sourceZone.dataset.originalText || sourceZone.innerText.split('\n')[1] || sourceZone.innerText;
        }
        
        // Altes Element entfernen
        let oldEl = document.getElementById("d" + nr);
        if(oldEl) oldEl.remove();

        // Neues im Pool erstellen
        createDragItem(nr, color, "pool");
    }
}

function handleDrop(zone, nr, color) {
    // 1. Wenn Zone schon voll ist -> Tauschen (Altes in Pool)
    if(zone.classList.contains("filled")) {
        let oldNr = zone.dataset.occupiedBy;
        let oldColor = zone.dataset.color;
        // Altes Element im DOM entfernen (war in Zone)
        let oldEl = document.getElementById("d" + oldNr);
        if(oldEl) oldEl.remove();
        // Zur√ºck in Pool
        createDragItem(oldNr, oldColor, "pool");
    }

    // 2. Quelle des neuen Items bereinigen (falls es aus anderer Zone kam)
    let dragItem = document.getElementById("d" + nr);
    if(dragItem) {
        let parentZone = dragItem.closest(".drop-zone");
        if(parentZone) {
            parentZone.classList.remove("filled");
            parentZone.dataset.occupiedBy = "";
            parentZone.innerText = parentZone.dataset.originalText || parentZone.innerText.split('\n')[1] || parentZone.innerText;
        }
        dragItem.remove(); // Remove draggable from old pos
    }

    // 3. In neue Zone einf√ºgen
    if(!zone.dataset.originalText) zone.dataset.originalText = zone.innerText;
    
    // Wir rendern hier die Box neu, aber WICHTIG: Sie muss draggable bleiben!
    zone.innerHTML = ""; // Text weg
    zone.classList.add("filled");
    zone.dataset.occupiedBy = nr;
    zone.dataset.color = color;

    // Erstelle Drag-Box direkt in der Zone
    createDragItem(nr, color, zone.id);
    
    // Label klein drunter
    let lbl = document.createElement("small");
    lbl.style.marginTop = "5px"; lbl.style.pointerEvents = "none";
    lbl.innerText = zone.dataset.originalText;
    zone.appendChild(lbl);
}

function checkDragAssignments() {
    let errors = 0;
    currentDragData.forEach((s, index) => {
        const zone = document.getElementById("zone-" + index);
        const occupied = zone.dataset.occupiedBy;
        if (occupied == zone.dataset.correctNr) { zone.classList.add("correct"); } 
        else { 
            zone.classList.add("wrong"); 
            zone.classList.add("shake-it"); // Animation
            errors++; 
        }
    });

    if (errors === 0) {
        // GEWONNEN
        score += 4; playerStats.coins += 2; saveStats();
        document.getElementById("score-label-drag").innerText = score;
        document.getElementById("check-drag-btn").style.display = "none";
        document.getElementById("next-drag-btn").style.display = "block";
    } else {
        // FEHLER (Kein Popup, nur visuell)
        lives--; 
        updateLivesDisplay(); 
        document.getElementById("check-drag-btn").disabled = true;
        
        setTimeout(() => {
            // Reset der falschen Zonen (nicht der Richtigen)
            currentDragData.forEach((s, index) => {
                let z = document.getElementById("zone-" + index);
                z.classList.remove("shake-it");
                // Wenn Spiel vorbei oder Runde neu geladen wird:
            });
            
            if(lives <= 0) { 
                finishGame(); 
            } else { 
                // Kurze Pause, dann Reset f√ºr n√§chsten Versuch dieser Runde
                loadDrag(); 
            }
        }, 1200);
    }
}

/* --- ALLGEMEINE GAME OVER LOGIK --- */
function finishGame() {
    let currentHighScore = playerStats.scores[currentModeKey];
    if(score > currentHighScore) {
        playerStats.scores[currentModeKey] = score;
        currentHighScore = score;
        saveStats();
    }
    document.getElementById("go-score").innerText = score;
    document.getElementById("go-best").innerText = currentHighScore;
    
    // Continue Button Check
    const btnCont = document.getElementById("btn-continue");
    if(playerStats.coins >= continueCost) {
        btnCont.disabled = false;
        btnCont.innerHTML = `Weiterspielen (-${continueCost} ü™ô)`;
        btnCont.style.opacity = "1";
    } else {
        btnCont.disabled = true;
        btnCont.innerHTML = `Zu wenig Coins (${playerStats.coins}/${continueCost})`;
        btnCont.style.opacity = "0.5";
    }
    document.getElementById("game-over-screen").classList.add("active");
}

function buyContinue() {
    if(playerStats.coins >= continueCost) {
        playerStats.coins -= continueCost;
        saveStats();
        lives = 3; 
        updateLivesDisplay();
        updateUIStats();
        document.getElementById("game-over-screen").classList.remove("active");
        if(currentModeKey.includes("quiz")) nextQuizQuestion(); else loadDrag();
    }
}

function restartGame() {
    if(currentModeKey === "quiz_easy") startQuiz(4);
    else if(currentModeKey === "quiz_hard") startQuiz(6);
    else startDragDrop();
}

/* --- FLASHCARDS (Normal & Zufall) --- */
let cardIdx=0; 
let flashcardDeck = [];
let isRandomFlash = false;

function startFlashcards(random){
    isRandomFlash = random;
    document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
    document.getElementById("flashcard-screen").classList.add("active");
    
    if(random) {
        flashcardDeck = [...SDGS].sort(() => Math.random() - 0.5);
    } else {
        flashcardDeck = [...SDGS]; // 1-17 Reihenfolge
    }
    
    cardIdx=0; 
    renderCardFront(); 
}

function renderCardFront() {
    let s = flashcardDeck[cardIdx];
    const c=document.getElementById("main-card");
    c.style.background=s.farbe; c.innerHTML=`<h1 style="color:white; font-size:100px">${s.nr}</h1>`;
    c.dataset.side = "front"; 
    document.getElementById("card-progress").innerText=`${cardIdx+1} / 17`;
}

function renderCardBack() {
    let s = flashcardDeck[cardIdx];
    const c=document.getElementById("main-card");
    c.style.background="white"; c.innerHTML=`<img src="${getImgUrl(s.nr)}">`;
    c.dataset.side = "back";
}

function flipCard(){
    const c=document.getElementById("main-card");
    if (c.dataset.side === "front") renderCardBack(); else renderCardFront();
}

function nextCard(){ 
    cardIdx++;
    if(cardIdx >= 17) {
        if(isRandomFlash) flashcardDeck = [...SDGS].sort(() => Math.random() - 0.5); // Neu mischen
        cardIdx = 0;
    }
    renderCardFront(); 
}

function prevCard(){ 
    cardIdx--;
    if(cardIdx < 0) cardIdx = 16;
    renderCardFront(); 
}

function showTable(){
    document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
    document.getElementById("table-screen").classList.add("active");
    const cont = document.getElementById("table-content"); cont.innerHTML = "";
    SDGS.forEach(s=>{
        const row = document.createElement("div"); row.className="list-row";
        row.innerHTML=`<div class="row-nr" style="background:${s.farbe}">${s.nr}</div><img src="${getImgUrl(s.nr)}" class="row-img"><div class="row-text">${s.titel}</div>`;
        cont.appendChild(row);
    });
}
</script>
</body>
</html>